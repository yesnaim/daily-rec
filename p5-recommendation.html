<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>추천 문구</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
  <script>
    Kakao.init('e3705272a1aa7ed987f050d9ceea6673');
  </script>
</head>

<body>
  <h1>추천 문구</h1>
  <div id="recommendation"
    style="font-size: 20px; font-weight: bold; padding: 20px; border: 1px solid #ccc; display: inline-block; margin-top: 20px;">
    <!-- 추천 문구가 여기에 표시됩니다 -->
  </div>
  <div style="margin-top: 20px;">
    <button onclick="restartSurvey()"
      style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">다시
      시작하기</button>
    <button onclick="goBack()"
      style="padding: 10px 20px; background-color: #f0ad4e; color: white; border: none; cursor: pointer;">뒤로 가기</button>
    <button onclick="downloadImage()"
      style="padding: 10px 20px; background-color: #2196F3; color: white; border: none; cursor: pointer;">이미지로
      저장하기</button>
    <button onclick="shareImage()"
      style="padding: 10px 20px; background-color: #FF5722; color: white; border: none; cursor: pointer;">클립보드에
      복사</button>
    <button onclick="shareToKakao()"
      style="padding: 10px 20px; background-color: #FFEB00; color: black; border: none; cursor: pointer;">카카오톡으로
      공유하기</button>
  </div>

  <script>
    const surveyData = JSON.parse(localStorage.getItem('surveyData')) || {};
    const recommendationDiv = document.getElementById('recommendation');

    const recommendations = {
      cautious: "신중한 당신에게, '작은 결정이 큰 변화를 만듭니다.'",
      adventurous: "도전적인 당신에게, '새로운 길을 두려워하지 마세요.'",
      empathetic: "공감 능력이 뛰어난 당신에게, '당신의 따뜻함이 세상을 밝힙니다.'",
      logical: "논리적인 당신에게, '명확한 사고가 성공의 열쇠입니다.'",
      other: "당신만의 특별한 성향을 응원합니다!"
    };

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    window.onload = function () {
      const traitFromUrl = getQueryParam('trait');
      const trait = traitFromUrl || surveyData.trait || 'other';
      recommendationDiv.innerText = recommendations[trait];
      // 디버깅용
      console.log(JSON.parse(localStorage.getItem('surveyData')));
    };

    function restartSurvey() {
      localStorage.clear();
      window.location.href = 'quotes.html';
    }

    function goBack() {
      window.history.back();
    }

    function downloadImage() {
      const element = document.getElementById('recommendation');
      html2canvas(element).then(canvas => {
        const link = document.createElement('a');
        link.download = '추천문구.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      }).catch(error => console.error('이미지 저장 실패:', error));
    }

    function shareImage() {
      const element = document.getElementById('recommendation');
      html2canvas(element).then(canvas => {
        canvas.toBlob(blob => {
          navigator.clipboard.write([
            new ClipboardItem({ 'image/png': blob })
          ]).then(() => {
            alert('이미지가 클립보드에 복사되었습니다. 카카오톡이나 다른 앱에 붙여넣기 해보세요!');
          }).catch(error => {
            console.error('클립보드 복사 실패:', error);
            alert('클립보드 복사에 실패했습니다.');
          });
        });
      }).catch(error => console.error('공유 실패:', error));
    }

    function shareToKakao() {
      const trait = surveyData.trait || 'other';
      const shareUrl = `https://yesnaim.github.io/daily-rec/p5-recommendation.html?trait=${trait}`;
      Kakao.Link.sendDefault({
        objectType: 'text',
        text: `추천 문구: ${recommendations[trait]}\n\n결과 보러가기: ${shareUrl}`,
        link: {
          mobileWebUrl: shareUrl,
          webUrl: shareUrl
        }
      });
    }
  </script>
</body>
<button onclick="window.location.href='quotes.html'" style="margin-top:20px;">나도 오늘의 문구 추천받기</button>
<button onclick="goToGoogleForm()">내 답변 Google Forms로 제출하기</button>
<script>
function goToGoogleForm() {
  const surveyData = JSON.parse(localStorage.getItem('surveyData')) || {};
  const formUrl = 'https://forms.gle/WztcvvWU5JNBT6369';
  const params = new URLSearchParams();

  // 오늘 기분이 어떤가요?
  if (surveyData.feelingOther) {
    params.set('entry.1473777974', '__other_option__');
    params.set('entry.1473777974.other_option_response', surveyData.feelingOther);
  } else {
    params.set('entry.1473777974', surveyData.feeling || '');
  }

  // (행복) 어떤 일 때문에 행복하셨나요?
  if (surveyData.happyreasonOther) {
    params.set('entry.925254719', '__other_option__');
    params.set('entry.925254719.other_option_response', surveyData.happyreasonOther);
  } else {
    params.set('entry.925254719', surveyData.happyreason || '');
  }

  // (고민) 요즘 가장 신경 쓰이는 고민이 있나요?
  if (surveyData.concernOther) {
    params.set('entry.700817478', '__other_option__');
    params.set('entry.700817478.other_option_response', surveyData.concernOther);
  } else {
    params.set('entry.700817478', surveyData.concern || '');
  }

  // (행복-성취)
  if (surveyData.happyDetailOther) {
    params.set('entry.133454939', '__other_option__');
    params.set('entry.133454939.other_option_response', surveyData.happyDetailOther);
  } else {
    params.set('entry.133454939', surveyData.happyDetail || '');
  }

  // (행복-좋은사람들)
  if (surveyData.happyPeopleOther) {
    params.set('entry.859710171', '__other_option__');
    params.set('entry.859710171.other_option_response', surveyData.happyPeopleOther);
  } else {
    params.set('entry.859710171', surveyData.happyPeople || '');
  }

  // (행복-특별한일)
  if (surveyData.happySpecialOther) {
    params.set('entry.369558758', '__other_option__');
    params.set('entry.369558758.other_option_response', surveyData.happySpecialOther);
  } else {
    params.set('entry.369558758', surveyData.happySpecial || '');
  }

  // 행복 기타 (장문형)
  params.set('entry.2063687973', surveyData.happylong1 || '');

  // 고민 세부(학업/인간관계/미래/가족/경제) - 선택된 고민 entry에만 concernDetail을 넣기
  switch (surveyData.selectedConcern) {
    case '학업':
      if (surveyData.concernDetailOther) {
        params.set('entry.2014154132', '__other_option__');
        params.set('entry.2014154132.other_option_response', surveyData.concernDetailOther);
      } else {
        params.set('entry.2014154132', surveyData.concernDetail || '');
      }
      break;
    case '인간관계':
      if (surveyData.concernDetailOther) {
        params.set('entry.761377551', '__other_option__');
        params.set('entry.761377551.other_option_response', surveyData.concernDetailOther);
      } else {
        params.set('entry.761377551', surveyData.concernDetail || '');
      }
      break;
    case '미래':
      if (surveyData.concernDetailOther) {
        params.set('entry.593882092', '__other_option__');
        params.set('entry.593882092.other_option_response', surveyData.concernDetailOther);
      } else {
        params.set('entry.593882092', surveyData.concernDetail || '');
      }
      break;
    case '가족':
      if (surveyData.concernDetailOther) {
        params.set('entry.1323373544', '__other_option__');
        params.set('entry.1323373544.other_option_response', surveyData.concernDetailOther);
      } else {
        params.set('entry.1323373544', surveyData.concernDetail || '');
      }
      break;
    case '경제':
      if (surveyData.concernDetailOther) {
        params.set('entry.396654452', '__other_option__');
        params.set('entry.396654452.other_option_response', surveyData.concernDetailOther);
      } else {
        params.set('entry.396654452', surveyData.concernDetail || '');
      }
      break;
    // 기타 고민 세부가 있다면 여기에 추가
  }

  // (고민-기타) (장문형)
  params.set('entry.764879100', surveyData.concernlong2 || '');

  // (성향) 평소에 나의 성향은 어떤가요?
  if (surveyData.traitOther) {
    params.set('entry.2080718979', '__other_option__');
    params.set('entry.2080718979.other_option_response', surveyData.traitOther);
  } else {
    params.set('entry.2080718979', surveyData.trait || '');
  }

  // 실제로 어떤 값이 들어가는지 콘솔에서 확인
  console.log(formUrl + '?' + params.toString());
  window.open(`${formUrl}?${params.toString()}`, '_blank');
}
</script>
</html>
